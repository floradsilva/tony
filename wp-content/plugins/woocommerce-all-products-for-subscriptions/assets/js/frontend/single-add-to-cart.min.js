!function(r){if("undefined"==typeof wcsatt_single_product_params)return;function e(t){return new(Backbone.Model.extend({get_active_scheme_key:function(){return this.get("active_scheme_key")},get_last_active_scheme_key:function(){return this.previous("active_scheme_key")},set_active_scheme:function(t){this.set({active_scheme_key:"0"!==t&&t})},set_schemes:function(t){this.set({schemes:t})},is_active_scheme_prorated:function(){return this.get_scheme_prop(this.get_active_scheme_key(),"is_prorated")},was_last_active_scheme_prorated:function(){return this.get_scheme_prop(this.get_last_active_scheme_key(),"is_prorated")},get_scheme_prop:function(t,e){var i=this.get("schemes");return void 0===i[t]||void 0===i[t][e]?null:i[t][e]},initialize:function(){this.set({schemes:{},active_scheme_key:""})}}))(t)}function i(t){return new(Backbone.View.extend({$el_options:!1,variation:!1,variation_options_render_location:"price_html",events:{"change .wcsatt-options-wrapper input":"active_scheme_changed",show_variation:"variation_found",reset_data:"reset_schemes"},active_scheme_changed:function(t){this.model.set_active_scheme(t.currentTarget.value)},variation_found:function(t,e){this.variation=e,"before_add_to_cart_button"===this.variation_options_render_location&&this.$el_options.html(e.satt_options_html).slideDown(250),this.initialize({$el_options:this.$el.find(".wcsatt-options-wrapper")})},variation_selected:function(){return!1!==this.variation},reset_schemes:function(){this.variation=!1,"before_add_to_cart_button"===this.variation_options_render_location&&this.$el_options.slideUp(250),this.model.set_schemes({}),this.model.set_active_scheme(!1)},has_schemes:function(){return 0<this.$el_options.length},find_schemes:function(){var e={};return this.has_schemes()&&this.$el_options.find(".subscription-option input").each(function(){var t=r(this).data("custom_data");e[t.subscription_scheme.key]=t.subscription_scheme}),e},initialize:function(t){if(this.variation_options_render_location=t.$el_options.hasClass("wcsatt-options-wrapper--variation")?"before_add_to_cart_button":"price_html",this.$el_options=t.$el_options,this.model.set_schemes(this.find_schemes()),this.has_schemes()){var e=this.$el_options.find('input[value="'+this.model.get_active_scheme_key()+'"]');0<e.length?e.prop("checked",!0):this.$el_options.find("input:checked").change()}else this.variation_selected()?this.model.set_active_scheme(null):this.model.set_active_scheme(!1)}}))(t)}function s(t){return new(Backbone.Model.extend({product:!1,xhr:!1,cached_responses:{},set_scheme_key:function(t){this.set({scheme_key:t})},get_scheme_key:function(){return this.get("scheme_key")},get_matching_subscriptions_html:function(){var e=this,t=this.product.schemes_model.get_active_scheme_key();if(this.xhr&&this.xhr.abort(),t=!1===t?"0":t,void 0!==this.cached_responses[t])e.set({html:this.cached_responses[t]}),e.trigger("matching_subscriptions_loaded");else{var i={action:"wcsatt_load_subscriptions_matching_product",product_id:this.product.get_product_id(),subscription_scheme:t};this.xhr=r.post(wcsatt_single_product_params.wc_ajax_url.toString().replace("%%endpoint%%",i.action),i,function(t){"success"===t.result?(e.set({html:t.html}),e.cached_responses[i.subscription_scheme]=t.html):(e.set({html:!1}),e.attributes.scheme_key=!1),e.trigger("matching_subscriptions_loaded")})}},active_scheme_changed:function(){this.xhr&&this.xhr.abort()},initialize:function(t){this.product=t.product;this.set({scheme_key:"",html:!1}),this.listenTo(this.product.schemes_model,"change:active_scheme_key",this.active_scheme_changed),this.on("change:scheme_key",this.get_matching_subscriptions_html)}}))(t)}function c(t){return new(Backbone.View.extend({$el_content:!1,product:!1,block_params:{message:null,fadeIn:0,fadeOut:0,overlayCSS:{background:"rgba( 255, 255, 255, 0 )",opacity:1}},events:{"click .wcsatt-add-to-subscription-action-input":"action_link_clicked"},action_link_clicked:function(){var t=this.model,e=this,i=!1;if(this.matching_subscriptions_visible()?i=this.toggle():this.model.get_scheme_key()===this.product.schemes_model.get_active_scheme_key()?i=this.toggle():(i=!0,this.$el.block(this.block_params),setTimeout(function(){t.set_scheme_key(e.product.schemes_model.get_active_scheme_key())},200)),!i)return!1},active_scheme_changed:function(){var t=this,e=!0;!1!==this.product.schemes_model.get_active_scheme_key()&&!this.product.schemes_model.is_active_scheme_prorated()||(e=!1),e?(t.$el.hasClass("open")&&t.model.get_scheme_key()!==t.product.schemes_model.get_active_scheme_key()&&(t.$el.block(t.block_params),!1!==t.product.schemes_model.get_last_active_scheme_key()&&!this.product.schemes_model.was_last_active_scheme_prorated()||t.toggle(!0),setTimeout(function(){t.model.set_scheme_key(t.product.schemes_model.get_active_scheme_key())},250)),setTimeout(function(){t.$el.slideDown(200)},50)):this.$el.slideUp(200)},add_to_subscription_button_clicked:function(t){var e=t.data.view.product.$form.find(".single_add_to_cart_button");if(e.hasClass("disabled"))return e.click(),!1},toggle:function(t){var e=this,i=(t=void 0!==t&&t)?0:200;return!0!==e.$el.data("animating")&&(e.$el.hasClass("closed")?(setTimeout(function(){e.$el_content.slideDown({duration:i,queue:!1,always:function(){e.$el.data("animating",!1)}})},10),e.$el.removeClass("closed").addClass("open")):(setTimeout(function(){e.$el_content.slideUp({duration:i,queue:!1,always:function(){e.$el.data("animating",!1)}})},10),e.$el.removeClass("open").addClass("closed")),e.$el.data("animating",!0),!0)},matching_subscriptions_visible:function(){return this.$el_content.is(":visible")},matching_subscriptions_loaded:function(){this.render()},render:function(){var t=this.model.get("html");this.$el.unblock(),!1===t?(window.alert(wcsatt_single_product_params.i18n_subs_load_error),this.matching_subscriptions_visible()&&this.toggle(),this.$el.find("input.wcsatt-add-to-subscription-action-input").prop("checked",!1)):(this.$el_content.html(t),this.matching_subscriptions_visible()||this.toggle())},initialize:function(t){this.product=t.product,this.$el_content=t.$el_content,this.listenTo(this.model,"matching_subscriptions_loaded",this.matching_subscriptions_loaded),this.listenTo(this.product.schemes_model,"change:active_scheme_key",this.active_scheme_changed),this.$el_content.on("click",".wcsatt-add-to-subscription-button",{view:this},this.add_to_subscription_button_clicked)}}))(t)}function n(i){var a=this;this.initialize_ui=function(){var t=i.$bundle_data.find(".wcsatt-options-wrapper");0<t.length&&(!1!==i.$addons_totals?i.$addons_totals.after(t):i.$bundle_price.after(t))},this.initialize_schemes=function(){i.satt_schemes=[],i.$bundle_wrap.find(".wcsatt-options-product .subscription-option").each(function(){var t=r(this),e=t.find("input").data("custom_data");i.satt_schemes.push({el:t,data:e,price_html:t.find(".subscription-price").html(),details_html:t.find(".subscription-details").prop("outerHTML")})})},this.integrate=function(){a.initialize_ui(),a.initialize_schemes(),i.$bundle_data.on("woocommerce-product-bundle-updated-totals",a.update_subscription_totals),i.$bundle_data.on("woocommerce-product-bundle-validation-status-changed",a.update_subscription_totals)},this.update_subscription_totals=function(t,o){0<o.satt_schemes.length&&r.each(o.satt_schemes,function(t,s){var e=o.get_price_html(),i=r(e).html();if(1===o.satt_schemes.length&&0===o.$bundle_wrap.find(".wcsatt-options-product .one-time-option").length)o.$bundle_price.find(".price").html(i+s.details_html);else{var c=s.el.find(".subscription-price");if(!0===s.data.overrides_price){var n=r.extend(!0,{},o.price_data);"inherit"===s.data.subscription_scheme.pricing_mode&&0<s.data.subscription_scheme.discount?(r.each(o.bundled_items,function(t,e){var i=e.bundled_item_id;s.data.discount_from_regular?n.prices[i]=n.regular_prices[i]*(1-s.data.subscription_scheme.discount/100):n.prices[i]=n.prices[i]*(1-s.data.subscription_scheme.discount/100),n.addons_prices[i]=n.addons_prices[i]*(1-s.data.subscription_scheme.discount/100)}),n.base_price=n.base_price*(1-s.data.subscription_scheme.discount/100)):"override"===s.data.subscription_scheme.pricing_mode&&(n.base_regular_price=Number(s.data.subscription_scheme.regular_price),n.base_price=Number(s.data.subscription_scheme.price)),n=o.calculate_subtotals(!1,n),n=o.calculate_totals(n),e=o.get_price_html(n),i=r(e).html()+" "}else i="";o.passes_validation()?c.html(i+s.details_html).find("span.total").remove():c.html(s.price_html),c.trigger("wcsatt-updated-bundle-price",[e,s,o,a])}})},this.integrate()}function o(a){var _=this;this.initialize_ui=function(){var t=a.$composite_data.find(".wcsatt-options-wrapper");0<t.length&&(!1!==a.composite_price_view.$addons_totals?a.composite_price_view.$addons_totals.after(t):a.$composite_price.after(t))},this.initialize_schemes=function(){a.satt_schemes=[],a.$composite_data.find(".wcsatt-options-product .subscription-option").each(function(){var t=r(this),e=t.find("input").data("custom_data");a.satt_schemes.push({el:t,data:e,price_html:t.find(".subscription-price").html(),details_html:t.find(".subscription-details").prop("outerHTML")})})},this.integrate=function(){_.initialize_schemes(),a.actions.add_action("initialize_composite",function(){_.initialize_ui(),0<a.satt_schemes.length&&(1<a.satt_schemes.length||0<a.$composite_data.find(".composite_wrap .wcsatt-options-product .one-time-option").length?(a.actions.add_action("composite_totals_changed",_.update_subscription_totals,101,_),a.actions.add_action("composite_validation_status_changed",_.update_subscription_totals,101,_)):a.filters.add_filter("composite_price_html",_.filter_price_html,10,_))},51,this)},this.filter_price_html=function(t,e,i){var s=a.satt_schemes[0].details_html;return t=r(t).append(s).prop("outerHTML")},this.update_subscription_totals=function(){0<a.satt_schemes.length&&r.each(a.satt_schemes,function(t,s){var e=a.composite_price_view.get_price_html(),i="",c=s.el.find(".subscription-price");if(!0===s.data.overrides_price){var n=r.extend(!0,{},a.data_model.price_data);_.maybe_add_bundle_totals_filters(s),"inherit"===s.data.subscription_scheme.pricing_mode&&0<s.data.subscription_scheme.discount?(r.each(a.get_components(),function(t,e){var i=e.component_id;s.data.discount_from_regular?n.prices[i]=n.regular_prices[i]*(1-s.data.subscription_scheme.discount/100):n.prices[i]=n.prices[i]*(1-s.data.subscription_scheme.discount/100),n.addons_prices[i]=n.addons_prices[i]*(1-s.data.subscription_scheme.discount/100)}),n.base_price=n.base_price*(1-s.data.subscription_scheme.discount/100)):"override"===s.data.subscription_scheme.pricing_mode&&(n.base_regular_price=Number(s.data.subscription_scheme.regular_price),n.base_price=Number(s.data.subscription_scheme.price)),n=a.data_model.calculate_subtotals(!1,n),_.maybe_remove_bundle_totals_filters(s);var o=a.data_model.calculate_totals(n);n.totals=o,e=a.composite_price_view.get_price_html(n),i=r(e).html()+" "}"pass"===a.api.get_composite_validation_status()?c.html(i+s.details_html).find("span.total").remove():c.html(s.price_html),c.trigger("wcsatt-updated-composite-price",[e,s,a,_])})},this.maybe_add_bundle_totals_filters=function(s){"inherit"===s.data.subscription_scheme.pricing_mode&&0<s.data.subscription_scheme.discount&&r.each(a.get_components(),function(t,e){if("bundle"===e.get_selected_product_type()){var i=e.get_bundle_script();i&&(i.satt_scheme=s,i.filters.add_filter("bundle_totals",_.filter_bundle_totals,10,_))}})},this.maybe_remove_bundle_totals_filters=function(t){"inherit"===t.data.subscription_scheme.pricing_mode&&0<t.data.subscription_scheme.discount&&r.each(a.get_components(),function(t,e){if("bundle"===e.get_selected_product_type()){var i=e.get_bundle_script();i&&(i.satt_scheme=!1,i.filters.remove_filter("bundle_totals",_.filter_bundle_totals))}})},this.filter_bundle_totals=function(t,e,i,s){if(!i.satt_scheme)return t;var c=i.satt_scheme.data,n=c.subscription_scheme.discount,o=r.extend(!0,{},e);return s=void 0===s?i.composite_data.component.get_selected_quantity():s,r.each(i.bundled_items,function(t,e){c.discount_from_regular?o.prices[e.bundled_item_id]=o.regular_prices[e.bundled_item_id]*(1-n/100):o.prices[e.bundled_item_id]=o.prices[e.bundled_item_id]*(1-n/100)}),o.base_price&&(c.discount_from_regular?o.base_price=Number(o.base_regular_price)*(1-n/100):o.base_price=Number(o.base_price)*(1-n/100)),i.satt_scheme=!1,o=i.calculate_subtotals(!1,o,s),t=(o=i.calculate_totals(o)).totals},this.integrate()}var a=function(t){this.$form=t,this.schemes_model=!1,this.schemes_view=!1,this.matching_subscriptions_model=!1,this.matching_subscriptions_view=!1,this.initialize=function(){this.schemes_model=new e({product:this}),this.matching_subscriptions_model=new s({product:this}),this.schemes_view=new i({model:this.schemes_model,el:t,$el_options:t.find(".wcsatt-options-wrapper")}),this.matching_subscriptions_view=new c({product:this,model:this.matching_subscriptions_model,el:t.find(".wcsatt-add-to-subscription-wrapper"),$el_content:t.find(".wcsatt-add-to-subscription-options")}),-1!=window.location.href.indexOf("switch-subscription")&&-1!=window.location.href.indexOf("item")&&t.prop("action",""),this.pao=new _(this)},this.get_product_id=function(){return t.find(".wcsatt-add-to-subscription-wrapper").data("product_id")}},_=function(c){var n=this;this.$addons_totals=!1,this.initialize=function(){if(!c.$form.hasClass("bundle_form")&&!c.$form.hasClass("composite_form")){var t=c.$form.find("#product-addons-total");0<t.length&&1==t.data("show-sub-total")&&(this.$addons_totals=t,this.$addons_totals.insertAfter(c.schemes_view.$el_options),c.schemes_model.on("change:active_scheme_key",this.active_scheme_changed),c.$form.on("show_variation",this.variation_changed))}},this.active_scheme_changed=function(){var t=!1===c.schemes_model.get_active_scheme_key()?"0":c.schemes_model.get_active_scheme_key(),e=c.schemes_view.$el_options.find('input[value="'+t+'"]').data("custom_data"),i=!!e&&e.display_price,s=!!e&&e.raw_price;!1!==i&&!1!==s&&(n.$addons_totals.data("price",i),n.$addons_totals.data("raw-price",s),c.$form.trigger("woocommerce-product-addons-update"))},this.variation_changed=function(){this.active_scheme_changed()},this.initialize()};function t(){r(".product form.cart").each(function(){!function(t){var e;t.data("satt_script")||((e=new a(t)).initialize(),t.data("satt_script",e))}(r(this))})}t(),r(".bundle_form .bundle_data").each(function(){r(this).on("woocommerce-product-bundle-initializing",function(t,e){e.is_composited()||new n(e)})}),r(".composite_form .composite_data").each(function(){r(this).on("wc-composite-initializing",function(t,e){new o(e)})}),r(document.body).on("wcsatt-initialize",function(){t()})}(jQuery);