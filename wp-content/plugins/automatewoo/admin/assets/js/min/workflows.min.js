!function(n,t){AW.Workflow=Backbone.Model.extend({getAction:function(t){var o=AW.workflow.get("actions");if(o[t])return o[t]}}),AW.WorkflowView=Backbone.View.extend({el:n("form#post"),$triggerSelect:n(".js-trigger-select"),$triggerDescription:n(".js-trigger-description"),initialize:function(){this.listenTo(this.model,"change:trigger",this.changeTrigger),this.model.set("prevTrigger",this.$triggerSelect.val()),this.insertMetaboxHelpTips()},changeTrigger:function(){AW.rules.resetAvailableRules(),n(document.body).trigger("wc-enhanced-select-init"),AW.initTooltips(),AW.Validate.validateAllFields(),AutomateWoo.Workflows.trigger_compatibility_warning()&&AW.workflowView.completeTriggerChange()},completeTriggerChange:function(){AW.rules.clearIncompatibleRules(),AutomateWoo.Workflows.clearIncompatibleActions(),AutomateWoo.Modal.close(),AutomateWoo.Workflows.refine_variables(),AutomateWoo.Workflows.refine_action_selects(),AutomateWoo.Workflows.maybe_disable_queueing(),this.updateTriggerDescription(),this.model.set("prevTrigger",this.$triggerSelect.val()),n(document.body).trigger("automatewoo_trigger_changed")},cancelTriggerChange:function(){this.$triggerSelect.val(this.model.get("prevTrigger")).trigger("change")},updateTriggerDescription:function(){var t=this.model.get("trigger");t&&t.description?this.$triggerDescription.html('<p class="aw-field-description">'+t.description+"</p>"):this.$triggerDescription.html("")},initAction:function(t,e){var o=this.model.getAction(t);o&&(e.attr("data-automatewoo-action-name",t),e.attr("data-automatewoo-action-group",o.group),e.attr("data-automatewoo-action-can-be-previewed",o.can_be_previewed)),e.find("[data-automatewoo-dynamic-select]").each(function(t,o){AW.workflowView.initDynamicActionSelect(n(o),e)}),AW.initTooltips()},initDynamicActionSelect:function(t,o){var e=t.attr("data-automatewoo-dynamic-select-reference"),i=o.find('.automatewoo-field[data-name="'+e+'"]');i.change(function(){AW.workflowView.updateDynamicActionSelect(t,i,o)})},updateDynamicActionSelect:function(e,t,o){if(!e.is(".automatewoo-field--loading")&&(e.find("option[value!='']").remove(),t.val())){var i=e.parents(".automatewoo-table__row");i.addClass("automatewoo-field-row--loading");var a={action:"aw_update_dynamic_action_select",action_name:o.data("automatewoo-action-name"),target_field_name:e.attr("data-name"),reference_field_value:t.val()};n.post(ajaxurl,a,function(t){i.removeClass("automatewoo-field-row--loading"),t.success&&n.each(t.data,function(t,o){e.append(n("<option/>",{value:t,text:o}))})})}},insertMetaboxHelpTips:function(){var t=this.model.get("metaBoxHelpTips");_.each(t,function(t,o){$metabox=n("#aw_"+o),$metabox.find("h2.hndle").append(t)})}}),AW.TriggerCompatibilityModalView=Backbone.View.extend({className:"aw-view-trigger-compatibility-modal",template:wp.template("aw-trigger-compatibility-modal"),data:null,initialize:function(t){this.data=t,this.$el.on("click",".js-confirm",function(){AW.workflowView.completeTriggerChange()}),this.$el.on("click",".js-close-automatewoo-modal",function(){AW.workflowView.cancelTriggerChange()})},render:function(){return this.$el.html(this.template(this.data)),this}}),AW.workflow=new AW.Workflow(t),AW.workflowView=new AW.WorkflowView({model:AW.workflow}),AW.Validate.init()}(jQuery,automatewooWorkflowLocalizeScript),jQuery(".meta-box-sortables").removeClass("meta-box-sortables"),jQuery(function(r){function t(){var e=r('input[name="aw_workflow_data[trigger_options][days_since_last_purchase]"]'),i=r('input[name="aw_workflow_data[trigger_options][days_since_last_purchase_max]"]');e.on("change keyup",function(){var t=e.val()?parseInt(e.val()):0,o="";t&&(o=t+3),i.attr("min",t+1),i.attr("placeholder",o)}).change()}AutomateWoo.Workflows={$triggers_box:r("#aw_trigger_box"),$actions_box:r("#aw_actions_box"),$actions_container:r(".aw-actions-container"),$action_template:r(".aw-action-template"),$trigger_select:r(".js-trigger-select").first(),init:function(){AutomateWoo.Workflows.init_triggers_box(),AutomateWoo.Workflows.init_actions_box(),AutomateWoo.Workflows.init_options_box()},init_triggers_box:function(){AutomateWoo.Workflows.$trigger_select.change(function(){AutomateWoo.Workflows.fill_trigger_fields(r(this).val())})},init_actions_box:function(){r(".automatewoo-action.js-open").each(function(){AutomateWoo.Workflows.action_edit_open(r(this))}),r(".js-aw-add-action").click(function(t){t.preventDefault(),AutomateWoo.Workflows.add_new_action()}),r(document).on("click",".js-edit-action",function(t){t.preventDefault();var o=r(this).parents(".automatewoo-action").first();o.is(".js-open")?AutomateWoo.Workflows.action_edit_close(o):AutomateWoo.Workflows.action_edit_open(o)}),r(document).on("click",".js-delete-action",function(t){t.preventDefault();var o=r(this).parents(".automatewoo-action").first();AutomateWoo.Workflows.action_delete(o)}),r(document).on("change",".js-action-select",function(){var t=r(this).parents(".automatewoo-action").first();AutomateWoo.Workflows.fill_action_fields(t,r(this).val())}),r(document).on("click","[data-automatewoo-preview]",function(t){t.preventDefault();var o=r(this).parents(".automatewoo-action").first();AutomateWoo.Workflows.preview_action(o)}),AW.workflow.get("isNew")||(AutomateWoo.Workflows.refine_action_selects(),AutomateWoo.Workflows.refine_variables(),AutomateWoo.Workflows.maybe_disable_queueing(),r(".automatewoo-action").each(function(t,o){AW.workflowView.initAction(r(o).find(".js-action-select").val(),r(o))}))},init_options_box:function(){var t=r(".aw-checkbox-enable-click-tracking");AutomateWoo.Workflows.maybe_hide_tracking_options(),t.click(function(){AutomateWoo.Workflows.maybe_hide_tracking_options()})},maybe_hide_tracking_options:function(){r(".aw-checkbox-enable-click-tracking").is(":checked")?r(".js-require-email-tracking").show():r(".js-require-email-tracking").hide()},fill_trigger_fields:function(t){AutomateWoo.Workflows.$triggers_box.find("tr.aw-trigger-option").remove(),t?(AutomateWoo.Workflows.$triggers_box.addClass("aw-loading"),r.ajax({method:"GET",url:ajaxurl,data:{action:"aw_fill_trigger_fields",trigger_name:t,workflow_id:AW.workflow.get("id"),is_new_workflow:AW.workflow.get("isNew")}}).done(function(t){t.success&&(AutomateWoo.Workflows.$triggers_box.find("tbody").append(t.data.fields),AutomateWoo.Workflows.$triggers_box.removeClass("aw-loading"),AW.workflow.set("trigger",t.data.trigger))})):AW.workflow.set("trigger",!1)},add_new_action:function(){var t,o=AutomateWoo.Workflows.get_number_of_actions()+1;r(".js-aw-no-actions-message").hide(),(t=AutomateWoo.Workflows.$action_template.clone()).removeClass("aw-action-template"),t.addClass("automatewoo-action"),AutomateWoo.Workflows.$actions_container.append(t),t.attr("data-action-number",o),AutomateWoo.Workflows.action_edit_open(t)},action_edit_open:function(t){var o=t.data("action-number");t.addClass("js-open"),t.find(".automatewoo-action__fields").slideDown(150),AW.initTooltips(),r.cookie("aw_editing_action_"+AW.workflow.get("id")+"_"+o,1)},action_edit_close:function(t){var o=t.data("action-number");t.removeClass("js-open"),t.find(".automatewoo-action__fields").slideUp(150),r.removeCookie("aw_editing_action_"+AW.workflow.get("id")+"_"+o)},action_delete:function(t){t.remove()},fill_action_fields:function(o,e){var i=o.data("action-number"),a=o.find(".js-action-select");AutomateWoo.Workflows.$actions_box.addClass("aw-loading"),o.find('tr.automatewoo-table__row:not([data-name="action_name"])').remove(),r.ajax({method:"GET",url:ajaxurl,data:{action:"aw_fill_action_fields",action_name:e,action_number:i,workflow_id:AW.workflow.get("id")}}).done(function(t){o.find(".automatewoo-table tbody").append(t.data.fields),AutomateWoo.Workflows.$actions_box.removeClass("aw-loading"),a.attr("name","aw_workflow_data[actions]["+i+"][action_name]"),o.find(".action-title").text(t.data.title),o.find(".js-action-description").html(t.data.description),AW.workflowView.initAction(e,o)})},get_number_of_actions:function(){return r(".automatewoo-action").length},refine_variables:function(){var i=AW.workflow.get("trigger");r(".aw-variables-group").each(function(t,o){var e=r(o).data("automatewoo-variable-group");-1==r.inArray(e,i.supplied_data_items)?r(o).hide():r(o).show()})},refine_action_selects:function(){r(".js-action-select").each(function(){r(this).find("option").each(function(){AutomateWoo.Workflows.is_action_compatible_with_current_trigger(r(this).val())?r(this).removeAttr("disabled"):r(this).attr("disabled",!0)})})},maybe_disable_queueing:function(){var t=AW.workflow.get("trigger");t&&t.allow_queueing?r("#aw_timing_box").show():r("#aw_timing_box").hide()},trigger_compatibility_warning:function(){var e=[],t=[];if(_.each(AW.rules.get("ruleOptions"),function(t){_.each(t.get("rules"),function(t){if(t.get("name")&&!AW.rules.isRuleAvailable(t.get("name"))){var o=t.get("object");e.push(o.title)}})}),r(".js-action-select").each(function(){AutomateWoo.Workflows.is_action_compatible_with_current_trigger(r(this).val())||t.push(r(this).find("option:selected").text())}),e.length||t.length){t=_.uniq(t),e=_.uniq(e);var o=new AW.TriggerCompatibilityModalView({incompatibleRules:e,incompatibleActions:t});return AutomateWoo.Modal.open(),AutomateWoo.Modal.contents(o.render().el),!1}return!0},clearIncompatibleActions:function(){r(".js-action-select").each(function(){if(!AutomateWoo.Workflows.is_action_compatible_with_current_trigger(r(this).val())){var t=r(this).parents(".automatewoo-action").first();AutomateWoo.Workflows.action_delete(t)}})},is_action_compatible_with_current_trigger:function(t){var e=!0,i=AW.workflow.get("trigger"),o=AW.workflow.getAction(t);return!o||(!o.required_data_items.length||(r.each(o.required_data_items,function(t,o){-1==r.inArray(o,i.supplied_data_items)&&(e=!1)}),e))},preview_action:function(t){var a,o=t.data("action-number"),e=AW.workflow.get("trigger"),n={};AutomateWoo.isEmailPreviewOpen()&&AutomateWoo.Workflows.$actions_box.addClass("aw-loading"),"undefined"!=typeof tinyMCE&&tinyMCE.triggerSave(),a="aw_workflow_data[actions]["+o+"]",t.find('[name*="'+a+'"]').each(function(t,o){var e,i;e=r(o).attr("name").replace(a,"").replace("[","").replace("]",""),i="checkbox"===r(o).attr("type")?o.checked?"1":"":r(o).val(),n[e]=i}),AutomateWoo.openLoadingEmailPreview(),r.ajax({method:"POST",url:ajaxurl,data:{action:"aw_save_preview_data",workflow_id:AW.workflow.get("id"),trigger_name:e?e.name:"",action_fields:n},success:function(t){AutomateWoo.open_email_preview("workflow_action",{workflow_id:AW.workflow.get("id"),action_number:o})},complete:function(){AutomateWoo.Workflows.$actions_box.removeClass("aw-loading")}})},init_ajax_wysiwyg:function(t){if("undefined"!=typeof tinymce&&void 0!==tinyMCEPreInit.mceInit.automatewoo_editor){var o,e,i;if(o=r.extend({},tinyMCEPreInit.mceInit.automatewoo_editor),e=r.extend({},tinyMCEPreInit.qtInit.automatewoo_editor),o.selector="#"+t,o.id=t,o.wp_autoresize_on=!1,tinyMCEPreInit.mceInit[o.id]=o,e.id=t,tinymce.$("#wp-"+t+"-wrap").hasClass("tmce-active")||!tinyMCEPreInit.qtInit.hasOwnProperty(t))try{tinymce.init(o)}catch(t){}try{i=quicktags(e),this.init_wysiwyg_buttons(i)}catch(t){}}},init_wysiwyg_buttons:function(t){for(i in canvas=t.canvas,name=t.name,settings=t.settings,html="",theButtons={},use="",settings.buttons&&(use=","+settings.buttons+","),edButtons)edButtons[i]&&(id=edButtons[i].id,use&&-1!==",strong,em,link,block,del,ins,img,ul,ol,li,code,more,close,".indexOf(","+id+",")&&-1===use.indexOf(","+id+",")||edButtons[i].instance&&edButtons[i].instance!==inst||(theButtons[id]=edButtons[i],edButtons[i].html&&(html+=edButtons[i].html(name+"_"))));use&&-1!==use.indexOf(",fullscreen,")&&(theButtons.fullscreen=new qt.FullscreenButton,html+=theButtons.fullscreen.html(name+"_")),"rtl"===document.getElementsByTagName("html")[0].dir&&(theButtons.textdirection=new qt.TextDirectionButton,html+=theButtons.textdirection.html(name+"_")),t.toolbar.innerHTML=html,t.theButtons=theButtons}},AutomateWoo.Workflows.init(),r(document.body).on("automatewoo_trigger_changed",function(){t()}),t()});
//# sourceMappingURL=workflows.min.js.map
